<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MisSup - Catálogo y Acceso</title>
  <style>
    /* Estilos combinados de login, registro y panel */
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: linear-gradient(to right, #004080, #002147);
      color: #222;
    }

    .container {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 350px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      text-align: center;
      margin: 60px auto;
    }

    .store-name {
      font-size: 1.8rem;
      font-weight: bold;
      color: #002147;
      margin-bottom: 10px;
    }

    h2 {
      color: #004080;
      margin-bottom: 20px;
    }

    input[type="text"],
    input[type="password"],
    input[type="email"],
    select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 12px;
    }

    input[type="submit"],
    button.toggle {
      background: #004080;
      color: #fff;
      border: none;
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
    }

    button.toggle {
      background: #002147;
    }

    .hidden {
      display: none;
    }

    /* Panel oculto hasta que el usuario inicia sesión */
    #panelContainer {
      display: none;
    }

    /* Estilos del catálogo (puedes copiar los tuyos aquí si quieres más detalle) */
    .main-content {
      padding: 28px;
      background: #fafafa;
    }

    .product-card {
      background: white;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 6px 16px rgba(22,40,80,0.06);
      margin-bottom: 20px;
    }

    .product-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      border-radius: 8px;
    }

    .product-card .name {
      font-weight: bold;
      font-size: 16px;
      margin-top: 8px;
    }

    .product-card .price {
      color: #004080;
      font-weight: bold;
    }
  </style>
</head>
<body>
<div class="container" id="authContainer">
  <div class="store-name">MisSup</div>
  <h2 id="form-title">Iniciar sesión</h2>

  <form id="login-form">
    <input type="text" name="usuario" placeholder="Usuario" required>
    <input type="password" name="clave" placeholder="Contraseña" required>
    <select name="tipo" required>
      <option value="" disabled selected>Selecciona tipo de usuario</option>
      <option value="usuario">Usuario normal</option>
      <option value="admin">Administrador</option>
    </select>
    <div class="actions">
      <input type="submit" value="Entrar">
      <button type="button" class="toggle" id="show-register">Registro</button>
    </div>
  </form>

  <form id="register-form" class="hidden">
    <input type="text" name="nombre" placeholder="Nombre completo" required>
    <input type="email" name="email" id="reg-email" placeholder="Correo electrónico" required>
    <input type="text" name="usuario_reg" placeholder="Usuario" required>
    <input type="password" name="clave_reg" placeholder="Contraseña" required>
    <select name="role" id="reg-role" required>
      <option value="usuario" selected>Usuario normal</option>
      <option value="admin">Administrador</option>
    </select>
    <div class="actions">
      <input type="submit" value="Registrar">
      <button type="button" class="toggle" id="show-login">Volver</button>
    </div>
  </form>
</div>
<div id="panelContainer">
  <div class="main-content">
    <h1>Catálogo de productos</h1>
    <div id="userInfo"></div>
    <div id="productsGrid"></div>
  </div>
</div>
<script>
  const DOMAIN_ALLOWED = '@tecmilenio.mx';
  const authContainer = document.getElementById('authContainer');
  const panelContainer = document.getElementById('panelContainer');
  const showRegisterBtn = document.getElementById('show-register');
  const showLoginBtn = document.getElementById('show-login');
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const title = document.getElementById('form-title');
  const regEmailInput = document.getElementById('reg-email');
  const regRoleSelect = document.getElementById('reg-role');
  const userInfo = document.getElementById('userInfo');
  const productsGrid = document.getElementById('productsGrid');

  let productos = [
    {
      nombre: "Laptop Gaming",
      precio: "1200.00",
      imagen: "https://images.unsplash.com/photo-1603302576837-37561b2e2302?w=400&h=240&fit=crop"
    },
    {
      nombre: "Camiseta Básica",
      precio: "25.99",
      imagen: "https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400&h=240&fit=crop"
    }
  ];

  showRegisterBtn.addEventListener('click', () => {
    loginForm.classList.add('hidden');
    registerForm.classList.remove('hidden');
    title.textContent = 'Registro';
    validateEmailForAdmin();
  });

  showLoginBtn.addEventListener('click', () => {
    registerForm.classList.add('hidden');
    loginForm.classList.remove('hidden');
    title.textContent = 'Iniciar sesión';
  });

  function validateEmailForAdmin() {
    const email = regEmailInput.value.trim().toLowerCase();
    const adminOption = regRoleSelect.querySelector('option[value="admin"]');
    if (!email.endsWith(DOMAIN_ALLOWED)) {
      adminOption.disabled = true;
      if (regRoleSelect.value === 'admin') regRoleSelect.value = 'usuario';
    } else {
      adminOption.disabled = false;
    }
  }

  regEmailInput.addEventListener('input', validateEmailForAdmin);

  loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const formData = new FormData(loginForm);
    fetch('/login', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      alert(data.mensaje || data.error);
      if (data.user) {
        localStorage.setItem('currentUser', JSON.stringify({ usuario: data.user, rol: data.mensaje.includes('admin') ? 'admin' : 'usuario' }));
        mostrarPanel();
      }
    })
    .catch(() => alert('Error al conectar con el servidor'));
  });

  registerForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = regEmailInput.value.trim().toLowerCase();
    const role = regRoleSelect.value;

    if (role === 'admin' && !email.endsWith(DOMAIN_ALLOWED)) {
      alert('Solo correos @tecmilenio.mx pueden registrarse como administradores.');
      return;
    }

    const formData = new FormData(registerForm);
    fetch('/register', {
      method: 'POST',
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      alert(data.mensaje || data.error);
      if (data.mensaje) {
                  registerForm.reset();
        registerForm.classList.add('hidden');
        loginForm.classList.remove('hidden');
        title.textContent = 'Iniciar sesión';
      }
    })
    .catch(() => alert('Error al conectar con el servidor'));
  });

  function mostrarPanel() {
    authContainer.style.display = 'none';
    panelContainer.style.display = 'block';

    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
    userInfo.innerHTML = `<p><strong>Bienvenido:</strong> ${currentUser.usuario} (${currentUser.rol})</p>`;
    renderProductos();
  }

  function renderProductos() {
    productsGrid.innerHTML = '';
    productos.forEach(p => {
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <img src="${p.imagen}" alt="${p.nombre}">
        <div class="name">${p.nombre}</div>
        <div class="price">$${p.precio}</div>
      `;
      productsGrid.appendChild(card);
    });
  }

  // Mostrar panel si ya hay sesión guardada
  const currentUser = JSON.parse(localStorage.getItem('currentUser'));
  if (currentUser) {
    mostrarPanel();
  }
</script>
</body>
</html>


