// ========= FUNCIONES PRINCIPALES =========
function mostrarProductos() {
  productosGrid.innerHTML = "";
  productos.forEach(p => {
    const card = document.createElement("div");
    card.className = "product-card";
    card.innerHTML = `
      <div class="product-image">🛍</div>
      <div class="product-info">
        <div class="product-name">${p.nombre}</div>
        <div class="product-category">${p.categoria}</div>
        <div class="product-price">$${p.precio}</div>
        <div>
          ${usuario.esAdmin
            ? `<button class="btn-edit" onclick="editar(${p.id})">Editar</button>
               <button class="btn-delete" onclick="borrar(${p.id})">Borrar</button>`
            : `<button class="btn-cart" onclick="agregarAlCarrito(${p.id})">Agregar al carrito</button>`
          }
        </div>
      </div>
    `;
    productosGrid.appendChild(card);
  });
}

function agregarAlCarrito(id) {
  const p = productos.find(x => x.id === id);
  carrito.push(p);
  actualizarContadorCarrito();
  alert(`${p.nombre} agregado al carrito`);
}

// ========= NAVEGACIÓN =========
document.getElementById("menuCarrito").addEventListener('click', () => {
  document.querySelectorAll('.sidebar-menu li a').forEach(item => {
    item.classList.remove('active');
  });
  document.getElementById("menuCarrito").classList.add('active');
  mostrarCarrito();
});

document.getElementById("menuHistorial").addEventListener('click', () => {
  document.querySelectorAll('.sidebar-menu li a').forEach(item => {
    item.classList.remove('active');
  });
  document.getElementById("menuHistorial").classList.add('active');
  mostrarHistorial();
});

document.getElementById("menuCatalogo").addEventListener('click', () => {
  document.querySelectorAll('.sidebar-menu li a').forEach(item => {
    item.classList.remove('active');
  });
  document.getElementById("menuCatalogo").classList.add('active');
  mostrarProductos();
});

// ======= CERRAR SESIÓN =======
document.getElementById("logoutBtn").addEventListener('click', () => {
  if (confirm("¿Estás seguro de que quieres cerrar sesión?")) {
    usuario = null;
    carrito = [];
    mainApp.style.display = 'none';
    loginScreen.style.display = 'flex';
    
    // Limpiar formularios
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
    document.getElementById('regName').value = '';
    document.getElementById('regEmail').value = '';
    document.getElementById('regPassword').value = '';
    document.getElementById('regConfirmPassword').value = '';
    
    // Volver a pestaña de login
    loginTab.classList.add('active');
    registerTab.classList.remove('active');
    loginForm.style.display = 'block';
    registerForm.style.display = 'none';
  }
});

// ======= MOSTRAR HISTORIAL =======
function mostrarHistorial() {
  pageTitle.textContent = "Historial de Compras";
  
  if (historial.length === 0) {
    contentArea.innerHTML = `
      <div class="cart-container">
        <div class="empty-cart">
          <h3>No hay compras realizadas</h3>
          <p>Tu historial de compras aparecerá aquí</p>
        </div>
      </div>
    `;
    return;
  }
  
  let html = `
    <div class="cart-container">
      <h2 style="color:#002147; margin-bottom:20px;">Tus Compras Anteriores</h2>
  `;
  
  historial.forEach((compra, index) => {
    html += `
      <div style="border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
          <strong>Compra #${index + 1}</strong>
          <span>Fecha: ${compra.fecha}</span>
        </div>
        <div style="margin-bottom: 10px;">
          ${compra.productos.map(p => `
            <div style="display: flex; justify-content: space-between; padding: 5px 0;">
              <span>${p.nombre}</span>
              <span>$${p.precio}</span>
            </div>
          `).join('')}
        </div>
        <div style="border-top: 1px solid #002147; padding-top: 10px; font-weight: bold; display: flex; justify-content: space-between;">
          <span>Total:</span>
          <span>$${compra.total}</span>
        </div>
      </div>
    `;
  });
  
  html += `</div>`;
  contentArea.innerHTML = html;
}
